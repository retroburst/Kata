<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Kata Loan Prediction - JavaScript</title>
        <link href="css/bootstrap.slate.min.css" rel="stylesheet"/>
        <link href="css/site.css" rel="stylesheet"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <div class="container">
            <div class="navbar">
                <div class="container">
                    <div class="navbar-header">
                        <span class="navbar-brand inactive">Kata Loan Prediction - JavaScript</span>
                    </div>
                    <div class="navbar-collapse collapse">
                    </div>
                </div>
            </div>
            <div id="input">
                <div class="jumbotron">
                    <h1>Predict.</h1>
                    <p>
                    Find out when your loan will end, how much interest you'll pay,
                    what difference an extra repayment
                    might make. Sometimes you need to time when your loan will end -
                    if you pay it off quickly you will want to avoid
                    unnecessary fees for early repayment by dragging it out some.
                    This is a code kata in JavaScript that runs entirely in the browser.
                    </p>
                </div>
                <div id="inputForm">
                </div>
            </div>
            <div id="results">
            </div>
        <hr />
        <footer>
            <p>MIT licensed software; retroburst (Andrew D).</p>
        </footer>
        </div>
        
        <script src="scripts/jquery.min.js"></script>
        <script src="scripts/jquery.validate.min.js"></script>
        <script src="scripts/moment.js"></script>
        <script src="scripts/combodate.js"></script>
        <script src="scripts/bootstrap.min.js"></script>
        <script src="scripts/nedb.min.js"></script>
        <script src="scripts/accounting.min.js"></script>
        <script src="scripts/handlebars.min.js"></script>
        <script src="scripts/kata.loan.prediction.js"></script>
        <script>
        var dateFormat = "DD/MM/YYYY";
        var templates = null;
        var defaultSettings = {
            startDate : moment(),
            targetEndDate : moment().add(25, 'year'),
            balance : 250000,
            interestRate : 5.00,
            minRepaymentAmount : 2000,
            minRepaymentDay : 1,
            extraRepaymentAmount : 1000,
            extraRepaymentDay : 20,
            currencySymbol : accounting.settings.currency.symbol
        };
        
        var initHandlebars = function initHandlebars(){
            Handlebars.registerHelper('formatDate', function(date) {
                var dateAsMoment = date;
                if(date instanceof Date){
                    dateAsMoment = moment(date);
                }
                if(dateAsMoment instanceof moment){
                    return(moment(date).format(dateFormat));
                }
            });
            
            Handlebars.registerHelper('formatMoney', function(amount) {
                if(!isNaN(amount)){
                    return(accounting.formatMoney(amount));
                }
            });
            
            Handlebars.registerHelper('formatDecimal', function(target) {
                if(!isNaN(target)){
                    return(target.toFixed(2));
                }
            });
            
            Handlebars.registerHelper('isAroundTargetEndDate',function isAroundTargetEndDate(transDate, targetEndDate){
                var transDateAsMoment = moment(transDate);
                var targetEndDateAsMoment = moment(targetEndDate);
                if(transDateAsMoment.month() == targetEndDateAsMoment.month()
                    && transDateAsMoment.year() == targetEndDateAsMoment.year()){
                    return(true);
                } else {
                    return(false);
                }
            });

            Handlebars.registerHelper('formatDateForComboDate', function(date) {
                var dateAsMoment = date;
                if(date instanceof Date){
                    dateAsMoment = moment(date);
                }
                if(dateAsMoment instanceof moment){
                    return(dateAsMoment.format(dateFormat));
                }
            });

            var templates = {
                inputFormTemplate : Handlebars.compile($("#input-form-template").html()),
                resultsTemplate : Handlebars.compile($("#results-template").html())
            };
            return(templates);
        };
        
        // init form
        var initInputForm = function initInputForm(){
            // TODO: defaults from proto or nedb
            var initialSettings = defaultSettings || storedSettings;
            // intial view setup
            $('#input').show();
            $('#results').hide();
            $('#inputForm').empty();
            $('#inputForm').append(templates.inputFormTemplate(initialSettings));
            
            $('#calculateButton').click(function(e){
                initResults();
            });
            
            $('.combodate').combodate(
                {
                minYear: 1975,
                maxYear: 2050,
                customClass: 'form-control combodate-inline',
                format: dateFormat
            });
        };
        
        var initResults = function initResults(){
            // calculate
            var context = new kataLoanPredictionApp.models.loanContext();
            context.balance = parseFloat($('#balance').val());
            context.interestRate = parseFloat($('#interestRate').val());
            context.minRepaymentAmount = parseFloat($('#minRepaymentAmount').val());
            context.minRepaymentDay = parseInt($('#minRepaymentDay').val());
            context.extraRepaymentAmount = parseFloat($('#extraRepaymentAmount').val());
            context.extraRepaymentDay = parseInt($('#extraRepaymentDay').val());
            context.startDate = moment($('#startDate').val(), dateFormat).toDate();
            context.targetEndDate = moment($('#targetEndDate').val(), dateFormat).toDate();
            var output = kataLoanPredictionApp.calculator.calculate(context);
            
            // clear table
            $('#results').empty();
            $('#results').append(templates.resultsTemplate({ context : context, output : output }));

            // show results
            // hide input
            $('#results').show();
            $('#input').hide();
            
            $('.start-over-button').click(function(e){
                initInputForm();
            });
            
            $("html, body").animate({ scrollTop: 0 }, "slow");
        };
        
        $(document).ready(function () {
            // init handlebars
            templates = initHandlebars();
            initInputForm();
        });
        </script>
        <script id="input-form-template" type="text/x-handlebars-template">
            <form class="well">
                <div class="form-group">
                    <label for="startDate" class="control-label required-field-label">Start Date</label>
                    <div class="form-inline">
                        <input type="text" id="startDate" name="startDate" data-template="D MMM YYYY" class="form-control combodate" value="{{formatDateForComboDate startDate}}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="startDate" class="control-label required-field-label">Target End Date</label>
                    <div class="form-inline">
                        <input type="text" id="targetEndDate" name="targetEndDate" data-template="D MMM YYYY" class="form-control combodate" value="{{formatDateForComboDate targetEndDate}}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="balance" class="control-label required-field-label">Balance</label>
                    <div class="input-group">
                        <span class="input-group-addon">{{currencySymbol}}</span>
                        <input class="form-control" id="balance" name="balance" type="text" value="{{balance}}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="interestRate" class="control-label required-field-label">Interest Rate</label>
                    <div class="input-group">
                        <span class="input-group-addon">%</span>
                        <input class="form-control" id="interestRate" name="interestRate" type="text" value="{{formatDecimal interestRate}}">
                    </div>
                </div>
                <div class="form-group">
                    <label for="minRepaymentAmount" class="control-label required-field-label">Min. Repayment Amount</label>
                    <div class="input-group">
                        <span class="input-group-addon">{{currencySymbol}}</span>
                        <input class="form-control" id="minRepaymentAmount" name="minRepaymentAmount" type="text" value="{{minRepaymentAmount}}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="minRepaymentDay" class="control-label required-field-label">Min. Repayment Day</label>
                    <div class="input-group">
                        <span class="input-group-addon">_</span>
                        <input class="form-control" id="minRepaymentDay" name="minRepaymentDay" type="text" value="{{minRepaymentDay}}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="extraRepaymentAmount" class="control-label">Extra Repayment Amount</label>
                    <div class="input-group">
                        <span class="input-group-addon">{{currencySymbol}}</span>
                        <input class="form-control" id="extraRepaymentAmount" name="extraRepaymentAmount" type="text" value="{{extraRepaymentAmount}}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="extraRepaymentDay" class="control-label">Extra Repayment Day</label>
                    <div class="input-group">
                        <span class="input-group-addon">_</span>
                        <input class="form-control" id="extraRepaymentDay" name="extraRepaymentDay" type="text" value="{{extraRepaymentDay}}"/>
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" id="calculateButton" class="btn btn-primary btn-lg">Calculate</button>
                </div>
            </form>
        </script>
        <script id="results-template" type="text/x-handlebars-template">
                <div class="jumbotron">
                    <h1>Results.</h1>
                    <p>
                    Loan ends on {{{formatDate output.loanEndsDate}}}<br />
                    Total interest paid from {{{formatDate output.interestStartDate}}}
                    was {{{formatMoney output.totalInterestPaid}}}<br />
                    {{#if output.targetEndDateHit}}
                        Target end date {{{formatDate context.targetEndDate}}} was
                        hit <u>perfectly</u>!
                    {{else}}
                        Target end date {{{formatDate context.targetEndDate}}} was
                        missed by <u>{{output.targetEndDateMissedInDays}}</u> days!
                    {{/if}}
                    </p>
                    <p>
                        <button type="button" class="btn btn-primary btn-lg start-over-button"><span class="glyphicon glyphicon-backward"></span> Start Over</button>
                    </p>
                </div>
                
                <table id="resultsTable" class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Credit</th>
                            <th>Debit</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                    {{#each output.transactions}}
                       <tr>
                       <td>{{{formatDate date}}}
                       {{#if (isAroundTargetEndDate date ../context.targetEndDate)}}
                           <span class="label label-danger">Target End</span>
                        {{/if}}
                       </td>
                            <td>{{type.description}}</td>
                            <td class="success"><p class="text-right">{{{formatMoney credit}}}</p></td>
                            <td class="danger"><p class="text-right">{{{formatMoney debit}}}</p></td>
                            <td><p class="text-right">{{{formatMoney balance}}}</p></td>
                        </tr>
                    {{/each}}
                    </tbody>
                </table>
                <div class="well">
                    <span class="parameter-display">Start Date <span class="label label-primary">
                        {{{formatDate context.startDate}}}
                    </span></span>
                    <span class="parameter-display">Target End Date <span class="label label-primary">
                        {{{formatDate context.targetEndDate}}}
                    </span></span>
                    <span class="parameter-display">Balance <span class="label label-primary">
                        {{{formatMoney context.balance}}}
                    </span></span>
                    <span class="parameter-display">Interest Rate <span class="label label-primary">
                        {{{formatDecimal context.interestRate}}}%
                    </span></span>
                    <span class="parameter-display">Min. Repay Amount <span class="label label-primary">
                        {{{formatMoney context.minRepaymentAmount}}}
                    </span></span>
                    <span class="parameter-display">Min. Repay Day <span class="label label-primary">
                        {{context.minRepaymentDay}}
                    </span></span>
                    <span class="parameter-display">Extra Repay Amount <span class="label label-primary">
                        {{{formatMoney context.extraRepaymentAmount}}}
                    </span></span>
                    <span class="parameter-display">Extra Repay Day <span class="label label-primary">
                        {{context.extraRepaymentDay}}
                    </span></span>
                </div>
                <p>
                <button type="button" class="btn btn-primary btn-lg start-over-button"><span class="glyphicon glyphicon-backward"></span> Start Over</button>
                </p>
        </script>
    </body>
</html>