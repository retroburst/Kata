<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Kata Loan Prediction - JavaScript</title>
        <link href="bootstrap.slate.min.css" rel="stylesheet"/>
        <link href="site.css" rel="stylesheet"/>
        <script id="input-form-template" type="text/x-handlebars-template">
                <form>
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label required-field-label" for="StartDate">Start Date</label>
                            <div class="col-sm-4 form-inline">
                                <input class="form-control combodate" data-template="D MMM YYYY" data-val="true" data-val-date="The field Start Date must be a date." data-val-required="The Start Date field is required." id="StartDate" name="StartDate" type="text" value="{{{formatDateForComboDate startDate}}}" />
                            </div>
                            <div class="col-sm-5 form-inline pull-left">
                                <span class="field-validation-valid" data-valmsg-for="StartDate" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label required-field-label" for="TargetEndDate">Target End Date</label>
                            <div class="col-sm-4 form-inline">
                                    <input class="form-control combodate" data-template="D MMM YYYY" data-val="true" data-val-date="The field Target End Date must be a date." data-val-required="The Target End Date field is required." id="TargetEndDate" name="TargetEndDate" type="text" value="{{{formatDateForComboDate targetEndDate}}}" />
                            </div>
                            <div class="col-sm-5 form-inline pull-left">
                                <span class="field-validation-valid" data-valmsg-for="TargetEndDate" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="col-sm-3 control-label required-field-label" for="Balance">Balance</label>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon currency-symbol">{{currencySymbol}}</span>
                                    <input class="form-control" data-val="true" data-val-number="The field Balance must be a number." data-val-required="The Balance field is required." id="Balance" name="Balance" type="text" value="{{balance}}" />
                                </div>
                            </div>
                            <div class="col-sm-7 pull-left">
                                <span class="field-validation-valid" data-valmsg-for="Balance" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        
                        
                        <div class="form-group">
                            <label class="col-sm-3 control-label required-field-label" for="InterestRate">Interest Rate</label>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <input class="form-control" data-val="true" data-val-number="The field Interest Rate must be a number." data-val-required="The Interest Rate field is required." id="InterestRate" name="InterestRate" type="text" value="{{{formatDecimal interestRate}}}" />
                                    <span class="input-group-addon">%</span>
                                </div>
                            </div>
                            <div class="col-sm-7 pull-left">
                                <span class="field-validation-valid" data-valmsg-for="InterestRate" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="col-sm-3 control-label required-field-label" for="MinRepaymentAmount">Minimum Repayment Amount</label>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon currency-symbol">{{currencySymbol}}</span>
                                    <input class="form-control" data-val="true" data-val-number="The field Minimum Repayment Amount must be a number." data-val-required="The Minimum Repayment Amount field is required." id="MinRepaymentAmount" name="MinRepaymentAmount" type="text" value="{{minRepaymentAmount}}" />
                                </div>
                            </div>
                            <div class="col-sm-7 pull-left">
                                <span class="field-validation-valid" data-valmsg-for="MinRepaymentAmount" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="col-sm-3 control-label required-field-label" for="MinRepaymentDay">Minimum Repayment Day</label>
                            <div class="col-sm-2">
                                <input class="form-control" data-val="true" data-val-number="The field Minimum Repayment Day must be a number." data-val-required="The Minimum Repayment Day field is required." id="MinRepaymentDay" name="MinRepaymentDay" type="text" value="{{minRepaymentDay}}" />
                            </div>
                            <div class="col-sm-7 pull-left">
                                <span class="field-validation-valid" data-valmsg-for="MinRepaymentDay" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="ExtraRepaymentAmount">Extra Repayment Amount</label>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon currency-symbol">{{currencySymbol}}</span>
                                    <input class="form-control" data-val="true" data-val-number="The field Extra Repayment Amount must be a number." id="ExtraRepaymentAmount" name="ExtraRepaymentAmount" type="text" value="{{extraRepaymentAmount}}" />
                                </div>
                            </div>
                            <div class="col-sm-7 pull-left">
                                <span class="field-validation-valid" data-valmsg-for="ExtraRepaymentAmount" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="ExtraRepaymentDay">Extra Repayment Day</label>
                            <div class="col-sm-2">
                                <input class="form-control" data-val="true" data-val-number="The field Extra Repayment Day must be a number." id="ExtraRepaymentDay" name="ExtraRepaymentDay" type="text" value="{{extraRepaymentDay}}" />
                            </div>
                            <div class="col-sm-7 pull-left">
                                <span class="field-validation-valid" data-valmsg-for="ExtraRepaymentDay" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="col-sm-3 control-label"></div>
                            <div class="col-sm-9">
                                <button type="button" id="CalculateButton" class="btn btn-primary btn-lg">Calculate</button>
                            </div>
                        </div>
                    </div>
                </form>
        </script>
        <script id="results-template" type="text/x-handlebars-template">
                <div class="jumbotron">
                    <h1>Results.</h1>
                    <p>
                    Loan ends on {{{formatDate output.loanEndsDate}}}<br />
                    Total interest paid from {{{formatDate output.interestStartDate}}}
                    was {{{formatMoney output.totalInterestPaid}}}<br />
                    {{#if output.targetEndDateHit}}
                        Target end date {{{formatDate context.targetEndDate}}} was
                        hit <u>perfectly</u>!
                    {{else}}
                        Target end date {{{formatDate context.targetEndDate}}} was
                        missed by <u>{{output.targetEndDateMissedInDays}}</u> days!
                    {{/if}}
                    </p>
                </div>
                
                <table id="resultsTable" class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Credit</th>
                            <th>Debit</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                    {{#each output.transactions}}
                       <tr>
                       <td>{{{formatDate date}}}
                       {{#if (isAroundTargetEndDate date ../context.targetEndDate)}}
                           <span class="label label-danger">Target End</span>
                        {{/if}}
                       </td>
                            <td>{{type.description}}</td>
                            <td class="success"><p class="text-right">{{{formatMoney credit}}}</p></td>
                            <td class="danger"><p class="text-right">{{{formatMoney debit}}}</p></td>
                            <td><p class="text-right">{{{formatMoney balance}}}</p></td>
                        </tr>
                    {{/each}}
                    </tbody>
                </table>
                <div class="well">
                    <span class="parameter-display">Start Date <span class="label label-primary">
                        {{{formatDate context.startDate}}}
                    </span></span>
                    <span class="parameter-display">Target End Date <span class="label label-primary">
                        {{{formatDate context.targetEndDate}}}
                    </span></span>
                    <span class="parameter-display">Balance <span class="label label-primary">
                        {{{formatMoney context.balance}}}
                    </span></span>
                    <span class="parameter-display">Interest Rate <span class="label label-primary">
                        {{{formatDecimal context.interestRate}}}%
                    </span></span>
                    <span class="parameter-display">Min. Repay Amount <span class="label label-primary">
                        {{{formatMoney context.minRepaymentAmount}}}
                    </span></span>
                    <span class="parameter-display">Min. Repay Day <span class="label label-primary">
                        {{context.minRepaymentDay}}
                    </span></span>
                    <span class="parameter-display">Extra Repay Amount <span class="label label-primary">
                        {{{formatMoney context.extraRepaymentAmount}}}
                    </span></span>
                    <span class="parameter-display">Extra Repay Day <span class="label label-primary">
                        {{context.extraRepaymentDay}}
                    </span></span>
                </div>
        </script>
    </head>
    <body>
        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <span class="navbar-brand inactive">Kata Loan Prediction - JavaScript</span>
                </div>
                <div class="navbar-collapse collapse">
                </div>
            </div>
        </div>
        <div class="container body-content">
            <p><br /></p>
            
            <div id ="input">
                <div class="jumbotron">
                    <h1>Predict.</h1>
                    <p>
                    Find out when your loan will end, how much interest you'll pay,
                    what difference an extra repayment
                    might make. Sometimes you need to time when your loan will end -
                    if you pay it off quickly you will want to avoid
                    unnecessary fees for early repayment by dragging it out some.
                    This is a code kata in JavaScript that runs entirely in the browser.
                    </p>
                </div>
                
                <div id="inputForm">

                </div>
            </div>
            
            <div id="results">
            </div>
            
        <hr />
        <footer>
            <p>MIT licensed software; retroburst (Andrew D).</p>
        </footer>
        </div>
        
        <script src="bower_components/jquery/dist/jquery.min.js"></script>
        <script src="bower_components/jquery-validation/dist/jquery.validate.min.js"></script>
        <script src="bower_components/moment/moment.js"></script>
        <script src="bower_components/combodate/src/combodate.js"></script>
        <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="bower_components/nedb/browser-version/out/nedb.min.js"></script>
        <script src="bower_components/accounting/accounting.min.js"></script>
        <script src="bower_components/handlebars/handlebars.min.js"></script>
        <script src="kata.loan.prediction.js"></script>
        <script>
        var dateFormat = "DD/MM/YYYY";
        var templates = null;
        var defaultSettings = {
            startDate : moment(),
            targetEndDate : moment().add(25, 'year'),
            balance : 250000,
            interestRate : 5.00,
            minRepaymentAmount : 2000,
            minRepaymentDay : 1,
            extraRepaymentAmount : 1000,
            extraRepaymentDay : 20,
            currencySymbol : accounting.settings.currency.symbol
        };
        
        var initHandlebars = function initHandlebars(){
            
            Handlebars.registerHelper('formatDate', function(date) {
                var dateAsMoment = date;
                if(date instanceof Date){
                    dateAsMoment = moment(date);
                }
                if(dateAsMoment instanceof moment){
                    return(moment(date).format(dateFormat));
                }
            });
            
            Handlebars.registerHelper('formatMoney', function(amount) {
                if(!isNaN(amount)){
                    return(accounting.formatMoney(amount));
                }
            });
            
            Handlebars.registerHelper('formatDecimal', function(target) {
                if(!isNaN(target)){
                    return(target.toFixed(2));
                }
            });
            
            Handlebars.registerHelper('isAroundTargetEndDate',function isAroundTargetEndDate(transDate, targetEndDate){
                var transDateAsMoment = moment(transDate);
                var targetEndDateAsMoment = moment(targetEndDate);
                if(transDateAsMoment.month() == targetEndDateAsMoment.month()
                    && transDateAsMoment.year() == targetEndDateAsMoment.year()){
                    return(true);
                } else {
                    return(false);
                }
            });

            Handlebars.registerHelper('formatDateForComboDate', function(date) {
                var dateAsMoment = date;
                if(date instanceof Date){
                    dateAsMoment = moment(date);
                }
                if(dateAsMoment instanceof moment){
                    return(dateAsMoment.format(dateFormat));
                }
            });

            var templates = {
                inputFormTemplate : Handlebars.compile($("#input-form-template").html()),
                resultsTemplate : Handlebars.compile($("#results-template").html())
            };
            return(templates);
        };
        
        // init form
        var initiInputForm = function initiInputForm(){
            // TODO: defaults from proto or nedb
            var initialSettings = defaultSettings || storedSettings;
            // intial view setup
            $('#input').show();
            $('#results').hide();
            $('#inputForm').empty();
            $('#inputForm').append(templates.inputFormTemplate(initialSettings));
            
            $('#CalculateButton').click(function(e){
                calculateLoan();
            });
            
            $('.combodate').combodate(
                {
                minYear: 1975,
                maxYear: 2050,
                customClass: 'form-control',
                format: dateFormat
            });
        };
        
        var calculateLoan = function calculateLoan(){
            console.log($('#StartDate').val());
            console.log($('#TargetEndDate').val());
            
            // calculate
            var context = new kataLoanPredictionApp.models.loanContext();
            context.balance = parseFloat($('#Balance').val());
            context.interestRate = parseFloat($('#InterestRate').val());
            context.minRepaymentAmount = parseFloat($('#MinRepaymentAmount').val());
            context.minRepaymentDay = parseInt($('#MinRepaymentDay').val());
            context.extraRepaymentAmount = parseFloat($('#ExtraRepaymentAmount').val());
            context.extraRepaymentDay = parseInt($('#ExtraRepaymentDay').val());
            context.startDate = moment($('#StartDate').val(), dateFormat).toDate();
            context.targetEndDate = moment($('#TargetEndDate').val(), dateFormat).toDate();
            console.log(context);
            
            var output = kataLoanPredictionApp.calculator.calculate(context);
            console.log(output);
            
            // clear table
            $('#results').empty();
            $('#results').append(templates.resultsTemplate({ context : context, output : output }));

            // show results
            // hide input
            $('#results').show();
            $('#input').hide();
            
            $("html, body").animate({ scrollTop: 0 }, "slow");
        };
        
        $(document).ready(function () {
            // init handlebars
            templates = initHandlebars();
            initiInputForm();
        });
        </script>
        
    </body>
</html>
